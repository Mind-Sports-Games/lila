## Client-side modules

### dev commands

Client builds are performed by the ui/build script.\
Stick to `ui/build -cr` (clean rebuild with watch mode) and leave it running when you can.\
NOTE - always use hard refresh (google it) or disable caching in the network tab of your browser inspector to pick up fresh changes.

NOTE - since we now use pnpm, it may be useful to know you can run `rm -rf node_modules pnpm-lock.yaml && pnpm store prune && pnpm i` if you want to ensure pnpm tries to solve completely the deps tree\
You can run `pnpm lint` and `pnpm format`, but there is also a new `pnpm lint-staged`.

Usage examples:

ui/build # builds all client assets in dev mode\
ui/build -w # builds all client assets and watches for changes\
ui/build -p # builds minified client assets (prod builds)\
ui/build --no-install # no pnpm install (to preserve local links you have set up)\
ui/build analyse site msg # specify modules (don't build everything)\
ui/build -w dasher chart # watch mode but only for given modules\
ui/build --tsc -w # watch mode but type checking only\
ui/build --sass msg notify # build css only for msg and notify modules\
ui/build --no-color # don't use color in logs\
ui/build --no-time # don't log the time\
ui/build --no-context # don't log the context ([sass], [esbuild], etc)

### overview - wip

#### external deps :

- **chessground** is used during a match (chessground.min.js is loaded on TV page for example)
- **stratops** is used on study, analysis
- submodules :
  - **shepherd** is used to create a guided tour of a website (the "i" icon on a study)
  - **ChessPursuit** is the little game that loads when you face a 404 error
  - **multiple-select** is used to select several options in a select list (used only in insights page which can not be accessed through the browser on playstrategy)

to fetch these 3 submodules in local, run :\
 `git submodule init`\
 `git submodule update`

#### ui modules :

<pre>
ui
|
 -- .build : esbuild, sass, tsc
|
 -- @types : definition files, for example for window.playstrategy
|
 -- draughts : the equivalent of stratutils ? (but specifically for draughts)
|
 -- draughtsground : the equivalent of chessground, but specifically for draughts
|
 -- draughtsround : the equivalent of round, but specifically for draughts
|
 -- insight (not used by playstrategy (can be found in the profile page under "div class="profile-side"" section (just below the user description and teams list)))
|
 -- palantir : voice chat
|	|
|	 -- peerjs
|
 -- round : handle a match - depends on chessground
|
 -- stratutils : depends on both stratops and chessground
</pre>

#### public folder :

<pre>
public/
|
  - compiled
|     ts files from ui modules are compiled into js files here
|     also includes deps.min.js, site.js, playstrategy.js
|
  - css
|     all css files generated by sass-dart.
|     Including the theme (dark, light, transp) as suffix.
|
  - javascripts
|     TODO
|
  - npm
|     * ui/analyse copies its tagify.min.js from its node_module into public/npm/tagify
|     * ui/site copies its chessground.min.js from its node_module into public/npm
|
  - vendor : handle by git submodules and ui/site package.json
      * (submodule) ChessPursuit
      * (submodule) shepherd
      * stockfish folders
      * highcharts folders
      * tagify ?
</pre>

to load a resource, there are at least 3 key places to look at :

- app/templating/AssetHelper.scala
- ui/site/src/component/assets.ts
- ui/common/src/xhr.ts

## Testing

Lichess use the Vitest testing framework.
We do not (yet?)

## CSS

The structure of a CSS module is as follows:

- css/
  - forum/
    - \_forum.scss # imports the files below
    - \_post.scss
    - \_search.scss
    - ...
  - build/
    - \_forum.scss # imports dependencies and `../forum/forum`.
    - forum.light.scss # generated
    - forum.dark.scss # generated
    - forum.transp.scss # generated
